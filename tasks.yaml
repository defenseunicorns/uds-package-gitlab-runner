includes:
  - setup: ./tasks/setup.yaml
  - create: ./tasks/create.yaml
  - deploy: ./tasks/deploy.yaml


tasks:
  - name: k3d-cluster-gitlab-runner
    description: Deploy k3d cluster and then UDS Gitlab Runner 
    actions:
      - task: setup:k3d-test-cluster
      - task: setup:gitlab-runner-namespace
      - task: setup:gitlab-runner-secret
      - task: create:runner-package
      - task: deploy:runner-package

  - name: gitlab-yolo
    description: Deploy Gitlab Yolo chart for testing purposes
    actions:
      - task: setup:k3d-test-cluster
      - cmd: mkdir -p build
      - cmd: cd build && zarf package create ../pkg-deps/gitlab/ --skip-sbom --confirm
      # - cmd: kubectl create namespace gitlab
      # - cmd: kubectl label namespace gitlab zarf.dev/agent=ignore
      # - cmd: cd build && zarf package deploy zarf-package-gitlab-runner-gitlab* --confirm

  - name: gitlab-runner
    description: Deploy UDS Gitlab-Runner on an existing cluster with existing Gitlab
    actions:
      - task: setup:gitlab-runner-registration-token
      - task: setup:gitlab-runner-namespace
      - task: setup:gitlab-runner-secret
      - task: create:runner-package
      - task: deploy:runner-package

  - name: cleanup-gitlab-runner
    description: Remove the gitlab-runner namespace
    actions:
      - cmd: kubectl delete namespace gitlab-runner --v=9

  - name: cleanup-cluster
    description: Delete the k3d cluster
    actions:
      - cmd: k3d cluster delete uds