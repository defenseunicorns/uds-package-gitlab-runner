includes:
  - setup: ./tasks/setup.yaml
  - create: ./tasks/create.yaml
  - deploy: ./tasks/deploy.yaml
  - test: ./tasks/test.yaml

tasks:
  - name: k3d-cluster-gitlab-runner
    description: Deploy k3d cluster and UDS Gitlab Runner with no Gitlab
    actions:
      - task: setup:k3d-test-cluster
      - task: setup:gitlab-runner-namespace
      - task: setup:gitlab-runner-secret
      - task: create:runner-package
      - task: deploy:runner-package

  - name: gitlab-yolo
    description: Deploy Gitlab Yolo chart for testing purposes
    actions:
      - task: setup:k3d-test-cluster
      - cmd: zarf package create ./pkg-deps/gitlab/ --skip-sbom --confirm
      - cmd: kubectl create namespace gitlab
      - cmd: kubectl label namespace gitlab zarf.dev/agent=ignore
      - cmd: zarf package deploy zarf-package-gitlab-runner-gitlab* --confirm -ltrace

  - name: gitlab-runner
    description: Deploy UDS Gitlab-Runner on an existing cluster with existing Gitlab
    actions:
      - task: setup:gitlab-runner-namespace
      - task: setup:gitlab-runner-secret
      - task: create:runner-package
      - task: deploy:runner-package

  - name: cluster-full
    description: Setup k3d cluster, deploy Gitlab, deploy Gitlab runner
    actions:
      - task: gitlab-yolo
      - task: gitlab-runner

  - name: test-package
    description: Test the health of Gitlab and Gitlab Runner deployments
    actions:
      - task: test:health-check

  - name: cleanup-gitlab-runner
    description: Remove the gitlab-runner namespace
    actions:
      - cmd: kubectl delete namespace gitlab-runner --v=9

  - name: cleanup-cluster
    description: Delete the k3d cluster
    actions:
      - cmd: k3d cluster delete uds