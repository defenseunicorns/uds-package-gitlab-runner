includes:
  - create: ./tasks/create.yaml
  - test: ./tasks/test.yaml
  - deploy:  ./tasks/deploy.yaml
  # todo: monitor deploy:package from uds-common-tasks for future use, currently doesnt work with creation of gitlab and gitlab runner zarf packages
  # - deploy: https://raw.githubusercontent.com/defenseunicorns/uds-common-tasks/v0.1.1/tasks/deploy.yaml
  - setup: https://raw.githubusercontent.com/defenseunicorns/uds-common-tasks/v0.1.1/tasks/setup.yaml
  - package: https://raw.githubusercontent.com/defenseunicorns/uds-common-tasks/v0.1.1/tasks/create.yaml

tasks:
  - name: cluster-full
    description: Setup k3d cluster, deploy Gitlab, deploy Gitlab runner
    actions:
      - task: gitlab-yolo
      - task: gitlab-runner

  - name: k3d-cluster-gitlab-runner
    description: Deploy k3d cluster and UDS Gitlab Runner with no Gitlab
    actions:
      - task: setup:k3d-test-cluster
      - task: create:gitlab-runner-namespace
      - task: create:gitlab-runner-secret
      - task: package:package
      - task: deploy:package

  - name: gitlab-yolo
    description: Deploy Gitlab Yolo chart for testing purposes
    actions:
      - task: setup:k3d-test-cluster
      - cmd: zarf package create ./pkg-deps/gitlab/ --skip-sbom --confirm
      - cmd: kubectl create namespace gitlab
      - cmd: kubectl label namespace gitlab zarf.dev/agent=ignore
      - cmd: zarf package deploy zarf-package-gitlab-runner-gitlab* --confirm

  - name: gitlab-runner
    description: Deploy UDS Gitlab-Runner on an existing cluster with existing Gitlab
    actions:
      - task: create:gitlab-runner-namespace
      - task: create:gitlab-runner-secret
      - task: package:package
      - task: deploy:package

  - name: test-package
    description: Test the health of Gitlab and Gitlab Runner deployments
    actions:
      - task: test:health-check

  - name: cleanup-gitlab-runner
    description: Remove the gitlab-runner namespace
    actions:
      - cmd: kubectl delete namespace gitlab-runner --v=9

  - name: cleanup-cluster
    description: Delete the k3d cluster
    actions:
      - cmd: k3d cluster delete uds
